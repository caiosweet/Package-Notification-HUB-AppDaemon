homeassistant:
  ######################################-#######################################
  ##                                CUSTOMIZE
  ######################################-#######################################
  customize:
    ## NODE ANCHORS
    package.node_anchors:
      customize: &customize
        package: "Centro Notifiche 🔔"
        site: "hassiohelp.eu 🌐"
        author: "Caio & Gianpi"
        version: "Google 5.0.0"

    group.notifier_player_google:
      <<: *customize
      friendly_name: "Gruppo Google"
      icon: mdi:speaker-multiple
    ## INPUT
    input_boolean.notifier_google_switch:
      <<: *customize
      friendly_name: "Google Off/On"
      icon: mdi:dots-horizontal-circle-outline
    input_select.notifier_tts_notify:
      <<: *customize
      friendly_name: "Servizio TTS"
      icon: mdi:form-select
    ## SELECT
    select.notifier_player_google:
      <<: *customize
      friendly_name: "Sorgente Google"
      icon: mdi:speaker-wireless
    ## SENSOR
    sensor.notifier_player_google:
      <<: *customize
      friendly_name: "Player Google Predefinito"

#######################################-#######################################
##                                   INPUT
#######################################-#######################################
input_boolean:
  notifier_google_switch:
input_select:
  notifier_tts_notify:
    options: ["Google Say", "Google Cloud", "Google Assistant", "Reverso"]

#######################################-#######################################
##                                 TEMPLATE
#######################################-#######################################
template:
  - select:
      - name: "notifier_player_google"
        state: "{{ state_attr('sensor.notifier_config', 'google_select') | default('unknown', true) }}"
        optimistic: true
        # options: |
        #   {{ (expand('group.notifier_player_google') | map(attribute='name') | list) }}
        options: |
          {{ (state_attr('sensor.notifier_config', 'google_media_player') | map('state_attr', 'friendly_name') | list) }}
        select_option:
          - variables:
              option: "{{ option }}"

## per sicurezza se non si creano i gruppi
          # {{ ((expand('group.notifier_player_google') | map(attribute='name') | list) +
          #  (state_attr('sensor.notifier_config', 'google_media_player') | map('state_attr', 'friendly_name') | list)) 
          #  | unique | list }}

  - trigger:
      - platform: state
        entity_id:
          - select.notifier_player_google
    sensor:
      - name: "notifier_player_google"
        # state: >-
        #   {% set domains = (states.group | list) + (states.media_player | list) %}
        #   {% set player = state_attr('group.notifier_player_google','entity_id') %}          
        #   {% set selected = trigger.to_state.state | lower %}
        #   {% for x in domains if x.name | lower == selected %}
        #     {% if x.domain == 'group' and player 
        #         and x.attributes.entity_id[0] in player | list %}
        #       {{ x.attributes.entity_id | join(', ') }}
        #     {% elif x.domain == 'media_player' %}
        #       {{ x.entity_id }}
        #     {% else %}
        #       {{ (player | join(', ')) if player else 'all' }}
        #     {% endif %}
        #   {% endfor %}

        ## TODO namespace unique plyer comma separate
        ## ora bug (manca virgola con doppioni)
        state: >-
          {% set domains = (states.group | list) + (states.media_player | list) %}
          {% set player = state_attr('group.notifier_player_google','entity_id') %}          
          {% set selected = trigger.to_state.state | lower %}
          {% for x in domains if x.name | lower == selected %}
            {% if x.domain in ['group', 'media_player'] and x.attributes.entity_id is defined 
                and player and x.attributes.entity_id[0] in player | list %}
               {{ x.attributes.entity_id | join(', ') }}
            {% elif x.domain == 'media_player' %}
              {{ x.entity_id }}
            {% else %}
              {{ (player | join(', ')) if player else 'all' }}
            {% endif %}
          {% endfor %}

        icon: >-
          {{ iif(',' in this.state | default('', true), 
              'mdi:speaker-multiple', 'mdi:speaker') }}
        attributes:
          selected: "{{ trigger.to_state.state | default }}"
